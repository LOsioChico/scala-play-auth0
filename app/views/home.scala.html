@import play.api.mvc.Flash

@(domain: String, clientId: String)(implicit flash: Flash)

@main("Home") {
<div class="min-h-screen bg-gray-50">
  <nav class="bg-white shadow-sm">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between h-16">
        <div class="flex">
          <div class="flex-shrink-0 flex items-center">
            <h1 class="text-xl font-bold text-gray-900">Scala Play Auth0</h1>
          </div>
        </div>
        <div class="flex items-center">
          <div id="auth-buttons">
            <a href="/login"
              class="ml-4 inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
              Sign in
            </a>
          </div>
        </div>
      </div>
    </div>
  </nav>

  <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
    <div class="px-4 py-6 sm:px-0">
      <!-- Unauthenticated Welcome Message -->
      <div id="unauthenticated-content" class="mt-8 space-y-6">
        <div class="text-center">
          <h2 class="text-3xl font-extrabold text-gray-900">
            Welcome to Scala Play Auth0
          </h2>
          <p class="mt-4 text-lg text-gray-600">
            This application demonstrates authentication using Auth0 in a Scala Play Framework application.
          </p>
        </div>
      </div>

      <!-- Authenticated Content with Posts -->
      <div id="authenticated-content" style="display: none">
        <div class="text-center mb-8">
          <h2 class="text-3xl font-extrabold text-gray-900">Latest Posts</h2>
        </div>
        <div class="grid gap-6 lg:grid-cols-2" id="posts-container">
          <!-- Posts will be dynamically inserted here -->
        </div>
      </div>
    </div>
  </main>
</div>

<script src="https://cdn.auth0.com/js/auth0/9.11/auth0.min.js"></script>
<script>
  window.onload = async () => {
    const webAuth = new auth0.WebAuth({
      domain: '@domain',
      clientID: '@clientId',
      redirectUri: window.location.origin + '/api/callback',
      scope: 'openid profile email'
    });

    const session = {
      isFetching: true,
      data: null
    };

    const test = await webAuth.checkSession({
      redirectUri: window.location.origin + '/api/callback',
      responseType: 'token',
      scope: 'openid profile email'
    }, (err, result) => {
      session.isFetching = false;
      session.data = result;
    });

    while (session.isFetching)
      await new Promise(resolve => setTimeout(resolve, 100));

    if (session.data) {
      const token = session.data.accessToken;

      const auth0Manager = new auth0.Management({
        domain: '@domain',
        token
      });

      const userInfo = {
        isFetchingUserInfo: true,
        data: null
      };

      await webAuth.client.userInfo(token, (err, user) => {
        userInfo.isFetchingUserInfo = false;
        userInfo.data = user;
      });

      while (userInfo.isFetchingUserInfo)
        await new Promise(resolve => setTimeout(resolve, 100));

      console.log(userInfo.data);

      // Update UI based on authentication state
      const authButtons = document.getElementById('auth-buttons');
      const authenticatedContent = document.getElementById('authenticated-content');
      const unauthenticatedContent = document.getElementById('unauthenticated-content');

      // Update auth buttons
      authButtons.innerHTML = `
        <span class="ml-4 text-gray-700">${userInfo.data.nickname}</span>
        <button onclick="logout()" class="ml-4 inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
          Sign out
        </button>
      `;

      // Show authenticated content and fetch posts
      authenticatedContent.style.display = 'block';
      unauthenticatedContent.style.display = 'none';

      try {
        const response = await fetch('/api/posts/1', {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (response.ok) {
          const post = await response.json();
          const postsContainer = document.getElementById('posts-container');

          // Create post card
          const postElement = `
            <div class="bg-white overflow-hidden shadow rounded-lg">
              <div class="px-4 py-5 sm:p-6">
                <h3 class="text-lg font-medium text-gray-900">${post.content}</h3>
                <div class="mt-4">
                  <button onclick="loadComments(${post.id}, '${token}')" class="text-sm text-indigo-600 hover:text-indigo-900">
                    View Comments
                  </button>
                </div>
                <div id="comments-${post.id}" class="mt-4 hidden">
                  <!-- Comments will be loaded here -->
                </div>
              </div>
            </div>
          `;
          postsContainer.innerHTML = postElement;
        }
      } catch (error) {
        console.error('Error fetching posts:', error);
      }
    }

    window.logout = async () => {
      await auth0Client.logout({
        returnTo: window.location.origin
      });
    };

    window.loadComments = async (postId, token) => {
      const commentsContainer = document.getElementById(`comments-${postId}`);

      if (commentsContainer.classList.contains('hidden')) {
        try {
          const response = await fetch(`/api/posts/${postId}/comments`, {
            headers: {
              'Authorization': `Bearer ${token}`
            }
          });

          if (response.ok) {
            const comments = await response.json();
            const commentsHtml = comments.map(comment => `
              <div class="mt-2 text-sm text-gray-600">
                <p class="font-medium">${comment.author}</p>
                <p>${comment.content}</p>
              </div>
            `).join('');

            commentsContainer.innerHTML = commentsHtml;
            commentsContainer.classList.remove('hidden');
          }
        } catch (error) {
          console.error('Error fetching comments:', error);
        }
      } else {
        commentsContainer.classList.add('hidden');
      }
    };

  };
</script>
}